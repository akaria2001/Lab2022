---
- name: Setup Lab
  hosts: lab
  serial: 2
  become: true
  ignore_unreachable: true
  ignore_errors: true
  tasks:
    - name: Ensure firewalld is at the latest version
      ansible.builtin.yum:
        name: firewalld
        state: present
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Disable firewalld Zone Drifting
      ansible.builtin.replace:
        path: /etc/firewalld/firewalld.conf
        regexp: 'AllowZoneDrifting=yes'
        replace: 'AllowZoneDrifting=no'
        backup: true
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
      notify:
        - Restart firewalld
    - name: Further lockdown - in future iteration this will be handled via Proxmox cloud-init bootstrap process
      ansible.builtin.replace:
        path: /etc/ssh/sshd_config
        regexp: '^PermitRootLogin yes$'
        replace: 'PermitRootLogin no'
        backup: true
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
      notify:
        - Restart sshd
    - name: Ensure firewalld is running
      ansible.builtin.service:
        name: firewalld
        state: started
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Install snapd
      ansible.builtin.apt:
        name: snapd
        state: present
      when: ansible_distribution == 'Ubuntu'
    - name: Install vim using apt
      ansible.builtin.apt:
        name: vim
        state: present
      when: ansible_distribution == 'Ubuntu'
    - name: Install emacs-nox using apt
      ansible.builtin.apt:
        name: emacs-nox
        state: present
      when: ansible_distribution == 'Ubuntu'
    - name: Install QEMU Guest Agent
      ansible.builtin.yum:
        name: qemu-guest-agent
        state: present
    - name: Enable QEMU Guest Agent
      ansible.builtin.service:
        name: qemu-guest-agent
        enabled: true
      notify:
        - Restart QEMU Agent
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Install vim using dnf
      ansible.builtin.yum:
        name: vim
        state: present
    - name: Install emacs-nox using dnf
      ansible.builtin.yum:
        name: emacs-nox
        state: present
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Install less using dnf
      ansible.builtin.yum:
        name: less
        state: present
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Pause for 10 seconds
      ansible.builtin.pause:
        seconds: 10
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
  handlers:
    - name: Restart firewalld
      ansible.builtin.service:
        name: firewalld
        state: restarted
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Restart sshd
      ansible.builtin.service:
        name: sshd
        state: restarted
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
    - name: Restart QEMU Agent
      ansible.builtin.service:
        name: qemu-guest-agent
        state: restarted
      when: ansible_distribution == 'Rocky' or ansible_distribution == 'AlmaLinux' or ansible_distribution == 'CentOS'
